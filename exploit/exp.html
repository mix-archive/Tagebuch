<!doctype html>
<head>
  <title></title>
  <meta charset="utf-8" />
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    iframe {
      width: 100%;
      height: 100vh;
      border: none;
    }
  </style>
</head>
<body>
  <iframe id="frame" src=""> </iframe>
  <script>
    const REDIRECTION_FROM = "http://localhost/"

    const wsUrl = new URL("/event", location.href);
    wsUrl.protocol = wsUrl.protocol.replace("http", "ws");

    const connection = new WebSocket(wsUrl.href);

    connection.onopen = async () => {
      await fetch("/update-page").then((res) => res.text());
    };

    connection.onmessage = async (event) => {
      const { kind, data } = JSON.parse(event.data);
      const frame = document.getElementById("frame");
      switch (kind) {
        case "id":
          frame.src = new URL(data, REDIRECTION_FROM);
          break;
        case "nonce":
          await fetch(`/update-page?known_nonce=${data}`).then((res) =>
            res.text(),
          );
          break;
      }
    };
  </script>
</body>
